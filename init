#!/bin/bash

export working_dir=$(pwd)
cd $(dirname $0)
export vdev_dir="$working_dir/.vdev"


source detail/utils


# 'vm' configuration

# for future extensibility
VirtualBox='VBoxManage'
vm='VirtualBox'
vm_manage=$(which "${!vm}")


help_message=\
'Usage:
	Path/To/virtual-dev/init <guest_name> <user> <password>
'


#
# Parameters

if [ $# -ne 3 ]
then
	printf_vdev_error 'wrong number of arguments'
	printf_message '%s' "$help_message"
	exit 1
fi

guest_name=$1
user=$2
password=$3


if ! detail/"$vm"/vm_exists "$guest_name"
then
	printf_vdev_error '"%s" does not exist' "$guest_name"
	exit 1
fi


#
# Main

project_root="$working_dir"


rm -rf "$vdev_dir"
mkdir "$vdev_dir"


vdevrc_vm="$vdev_dir/vm"

conf_add "$vdevrc_vm" 'vm' "$vm"
conf_add "$vdevrc_vm" 'vm_manage' "$vm_manage"
conf_add "$vdevrc_vm" 'guest_name' "$guest_name"
conf_add "$vdevrc_vm" 'user' "$user"
conf_add "$vdevrc_vm" 'password' "$password"


# Shared folder

project_name=$(basename "$project_root")


if detail/"$vm"/is_running "$guest_name"
then
	printf_vdev_error '"%s" is currently running, please shut it down' "$guest_name"
	exit 1
fi

printf_message 'Creating working directory on "%s"...' "$guest_name"
detail/"$vm"/shared_folder "$project_name" "$project_root"
if [ $? != 0 ]
then
	printf_vdev_error 'failed to create shared folder'
	exit 1
fi

printf_message 'Waiting for "%s" to start...' "$guest_name"
detail/"$vm"/start_vm
if [ $? != 0 ]
then
	printf_vdev_error 'failed to start "%s"' "$guest_name"
	exit 1
fi

printf_message 'Waiting for "%s" to login...' "$user"
output=$(detail/find_disk "$project_root")
if [ $? != 0 ]
then
	printf_vdev_error 'failed to find shared disk with project'
	exit 1
fi

guest_shared_disk="$output"


printf_message 'Finishing initialization...'


# Configuration

cp -R guest "$vdev_dir/"

vdevrc_conf="$vdev_dir/conf"

conf_add "$vdevrc_conf" 'guest_root_dir' "$guest_shared_disk"
conf_add "$vdevrc_conf" 'guest_vdevrc_guest_dir' '$guest_root_dir/.vdev/guest/'
conf_add "$vdevrc_conf" 'guest_project_property_bat' '$guest_vdevrc_guest_dir/project_property.bat'
conf_add "$vdevrc_conf" 'guest_build_bat' '$guest_vdevrc_guest_dir/build.bat'
conf_add "$vdevrc_conf" 'guest_run_bat' '$guest_vdevrc_guest_dir/run.bat'
conf_add "$vdevrc_conf" 'guest_clean_bat' '$guest_vdevrc_guest_dir/clean.bat'


printf_message 'Done.'

