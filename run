#!/bin/bash

export working_dir=$(pwd)
cd $(dirname $0)
export vdevrc_dir="$working_dir/vdevrc"


source "$vdevrc_dir/vm"
source "$vdevrc_dir/conf"
source detail/utils
source detail/dictionary


#
# Parameters

solution_path=$1
target=$2
configuration=$3


#
# Main

solution_dir=$(dirname "$solution_path")
solution_info_dir=$(sln_info_dir_name "$solution_path")

vs_version=$(detail/vsversion "$working_dir/$solution_path")

solution_cache="$vdevrc_dir/$solution_info_dir/solution.cache"
detail/loadprojpaths "$working_dir/$solution_path" "$solution_cache"

project_relative_path=$(dictionary_find "$solution_cache" "$target")
project_path="$working_dir/$solution_dir/$project_relative_path"
project_dir=$(dirname "$project_relative_path")

properties_path="$vdevrc_dir/$solution_info_dir/$target.$configuration.properties"
detail/loadprojprops "$vs_version" "$solution_dir" "$project_path" "$configuration" "$properties_path"
source "$properties_path"

binary_name="$name$extension"
detail/"$vm"/execute "$guest_run_bat" "$guest_root_dir/$solution_dir/$project_dir" "$out_dir" "$binary_name"
retval=$?
printf "\n" # if put newline in Windows then it can be swallowed

exit $retval

